<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
      <title>stephendnicholas.com</title>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta http-equiv="content-language" content="en-gb" />
      <meta name="description" content="tech blog">
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
      <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,400,300,700|Lora:400,700,400italic" rel="stylesheet" type="text/css">
      <link rel="stylesheet" type="text/css" href="/css/main.css" />
      <link href="atom.xml" type="application/atom+xml" rel="alternate" title="Site ATOM Feed">
  </head>

  <body>
    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <div class="off-canvas">
      <figure class="avatar">
        <img src="/assets/img/avatar.jpg" alt="Picture" title="That's me, Stephen Nicholas.">
      </figure>
      <div class="bio">
          <h1>Hi, I'm Stephen Nicholas.</h1>
          <p>And this is my blog. I'm a software engineer by trade (but mostly for fun) with a wide variety of experience and interests. Some of which I'll write about here.</p>
      </div>
      <nav>
        <h6>Look me up on</h6>
        <ul>
          
          <li><a href="https://twitter.com/sd_nicholas">Twitter</a></li>
          
          
          <li><a href="https://github.com/stephendnicholas">Github</a></li>
          
          
          <li><a href="https://www.linkedin.com/in/stephendnicholas">LinkedIn</a></li>
          
        </ul>
      </nav>
    </div>


    <div class="site-wrapper">

      <header>
        <div class="h-wrap">
          <h1 class="title"><a href="/" title="Back to Homepage">stephendnicholas.com</a></h1>
          <a class="menu-icon" title="Open Bio"><span class="lines"></span></a>
        </div>
      </header>

      <main>
        <section class="single-wrap">
  <article class="single-content" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="feat">
      <h5 class="page-date">
        <time datetime="2011-06-10T00:00:00-06:00" itemprop="datePublished">
          10 June 2011
        </time>
      </h5>
    </div>
    <h1 class="page-title" itemprop="name headline">How to use the Android HandlerThread</h1>
    <div itemprop="articleBody">
      <p>Today I’m going to talk about something I ran into recently that turned out to be very simple, despite initially seeming a little confusing, the Android <a href="http://developer.android.com/reference/android/os/HandlerThread.html"><code>HandlerThread</code></a> class.</p>

<p>So, first of all, why did I run into this? Well, basically I’ve been doing some work to improve the multi-threading of one of my applications, by splitting off some of the background work into a number of different threads; and to allow those threads to be easily interacted with, I wanted each of them to have their own <a href="http://developer.android.com/reference/android/os/Handler.html"><code>Handler</code></a>. </p>

<p>Now I’d read how to turn a thread into a <a href="http://developer.android.com/reference/android/os/Handler.html"><code>Handler</code></a> thread by calling <code>Looper.prepare()</code>, setting up my <a href="http://developer.android.com/reference/android/os/Handler.html"><code>Handler</code></a> &amp; then calling <code>Looper.loop()</code>; however this left my thread unable to perform its own background activities and so I ended up creating sub-threads / runnables and things started getting rather messy.</p>

<p>Assuming there must be a better way to do this, I eventually came across <a href="http://developer.android.com/reference/android/os/HandlerThread.html"><code>HandlerThread</code></a>, which is described in the Android documentation as:</p>

<blockquote>
  <p>Handy class for starting a new thread that has a looper. The looper can then be used to create handler classes. Note that start() must still be called. </p>
</blockquote>

<p>Now, in retrospect that actually seems quite clear- so I’m hoping that by writing this post, I’m not just exposing my stupidity- but initially I was a little unsure what it meant and how to use it.</p>

<p>Anyway, long story short, after some searching and some experimentation, I came across the correct way to use it. Which is, unsurprisingly, very similar to how it’s described above:</p>

<p>First of all you create and start a <a href="http://developer.android.com/reference/android/os/HandlerThread.html"><code>HandlerThread</code></a>, which creates a thread with a <a href="http://developer.android.com/reference/android/os/Looper.html"><code>Looper</code></a>:  </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Create and start the handler thread &amp; give it a custom name  </span>
<span class="n">HandlerThread</span> <span class="n">handlerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HandlerThread</span><span class="o">(</span><span class="s">&quot;MyHandlerThread&quot;</span><span class="o">);</span>  
<span class="n">handlerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span></code></pre></div>

<p>You then get the <a href="http://developer.android.com/reference/android/os/Looper.html"><code>Looper</code></a> from the <a href="http://developer.android.com/reference/android/os/HandlerThread.html"><code>HandlerThread</code></a> as follows:  </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Get the looper from the handlerThread  </span>
<span class="n">Looper</span> <span class="n">looper</span> <span class="o">=</span> <span class="n">handlerThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">();</span></code></pre></div>

<p>Note that the above method call can return null, in the unlikely event that the <a href="http://developer.android.com/reference/android/os/HandlerThread.html"><code>HandlerThread</code></a> not been started or if for any reason <code>isAlive()</code> returns false. Practically I think this is unlikely to happen and I’m not sure if there’s anything sensible to do if it does, so I wouldn’t worry about it too much.</p>

<p>You can then create your <a href="http://developer.android.com/reference/android/os/Handler.html"><code>Handler</code></a>, passing in the <a href="http://developer.android.com/reference/android/os/Looper.html"><code>Looper</code></a> for it to use  </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Create a new handler- passing in the looper for it to use  </span>
<span class="n">Handler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Handler</span><span class="o">(</span><span class="n">looper</span><span class="o">);</span></code></pre></div>

<p>And that’s all there is to it. You’ve now you got your own <a href="http://developer.android.com/reference/android/os/Handler.html"><code>Handler</code></a> running in it’s own thread. Simple, right?</p>

<p>And finally, when your thread is finished, you can shut down the <a href="http://developer.android.com/reference/android/os/HandlerThread.html"><code>HandlerThread</code></a> as follows:  </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Shut down the HandlerThread  </span>
<span class="n">handlerThread</span><span class="o">.</span><span class="na">quit</span><span class="o">();</span></code></pre></div>

<p>Just for completeness, below is an example of a complete class that extends thread and uses a <a href="http://developer.android.com/reference/android/os/HandlerThread.html"><code>HandlerThread</code></a> to create a <a href="http://developer.android.com/reference/android/os/Handler.html"><code>Handler</code></a> for inter-thread communication. As a side note, it also demonstrates the use of the <a href="http://developer.android.com/reference/android/os/Handler.Callback.html"><code>Handler.Callback</code></a> interface to save you having to subclass <a href="http://developer.android.com/reference/android/os/Handler.html"><code>Handler</code></a> for performing your custom message handling.  </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">stephendnicholas</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Handler</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.os.Handler.Callback</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.os.HandlerThread</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.os.Looper</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.os.Message</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="kd">implements</span> <span class="n">Callback</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CUSTOM_MESSAGE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Object</span><span class="o">();</span>

  <span class="kd">public</span> <span class="nf">ExampleThread</span><span class="o">()</span> <span class="o">{</span>  
  <span class="o">}</span>

  <span class="nd">@Override</span>  
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>  
    <span class="c1">// Create and start the HandlerThread- it requires a custom name  </span>
    <span class="n">HandlerThread</span> <span class="n">handlerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HandlerThread</span><span class="o">(</span><span class="s">&quot;MyHandlerThread&quot;</span><span class="o">);</span>  
    <span class="n">handlerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="c1">// Get the looper from the handlerThread  </span>
    <span class="c1">// Note: this may return null  </span>
    <span class="n">Looper</span> <span class="n">looper</span> <span class="o">=</span> <span class="n">handlerThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">();</span>

    <span class="c1">// Create a new handler- passing in the looper to use and this class as  </span>
    <span class="c1">// the message handler  </span>
    <span class="n">Handler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Handler</span><span class="o">(</span><span class="n">looper</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>

    <span class="c1">// While this thread is running  </span>
    <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>

      <span class="c1">// TODO- custom thread logic</span>

      <span class="c1">// Wait on mutex  </span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mutex</span><span class="o">)</span> <span class="o">{</span>  
        <span class="k">try</span> <span class="o">{</span>  
          <span class="n">mutex</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>  
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
          <span class="c1">// Don&#39;t care  </span>
        <span class="o">}</span>  
      <span class="o">}</span>  
    <span class="o">}</span>

    <span class="c1">// Tell the handler thread to quit  </span>
    <span class="n">handlerThread</span><span class="o">.</span><span class="na">quit</span><span class="o">();</span>  
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>  
    <span class="c1">// Set running to false  </span>
    <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="c1">// Wake anyone waiting on mutex  </span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mutex</span><span class="o">)</span> <span class="o">{</span>  
      <span class="n">mutex</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>  
    <span class="o">}</span>  
  <span class="o">}</span>

  <span class="nd">@Override</span>  
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>  
      <span class="k">case</span> <span class="nl">CUSTOM_MESSAGE:</span>  
      <span class="c1">// TODO- custom logic  </span>
      <span class="k">break</span><span class="o">;</span>

      <span class="k">default</span><span class="o">:</span>  
      <span class="c1">// Return false- as we have not handled the message  </span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>  
    <span class="o">}</span>

    <span class="c1">// Return true- as we have handled the message  </span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>  
  <span class="o">}</span>

<span class="o">}</span></code></pre></div>


    </div>
    
    <div class="share-title">Share via</div>
    
    <div class="feat share">
      <a href="http://twitter.com/share?text=How to use the Android HandlerThread - " class="popup">
        <span class="icon-twitter"></span>
      </a>
    </div>
    
    <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//stephendnicholas.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    
  </article>
</section>

      </main>

      <footer>
        <small>&copy; Stephen Nicholas, 2011 &ndash; 2016 </small>
      </footer>

    </div>
    

    <script src="/js/main.js"></script>
    
    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-72835313-1', 'stephendnicholas.com');
        ga('send', 'pageview');
      </script>
    

  </body>
</html>
