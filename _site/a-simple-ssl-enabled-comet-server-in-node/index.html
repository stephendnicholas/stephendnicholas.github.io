<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
      <title>stephendnicholas.com</title>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta http-equiv="content-language" content="en-gb" />
      <meta name="description" content="tech blog">
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
      <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,400,300,700|Lora:400,700,400italic" rel="stylesheet" type="text/css">
      <link rel="stylesheet" type="text/css" href="/css/main.css" />
      <link href="atom.xml" type="application/atom+xml" rel="alternate" title="Site ATOM Feed">
  </head>

  <body>
    <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <div class="off-canvas">
      <figure class="avatar">
        <img src="/assets/img/avatar.jpg" alt="Picture" title="That's me, Stephen Nicholas.">
      </figure>
      <div class="bio">
          <h1>Hi, I'm Stephen Nicholas.</h1>
          <p>And this is my blog. I'm a software engineer by trade (but mostly for fun) with a wide variety of experience and interests. Some of which I'll write about here.</p>
      </div>
      <nav>
        <h6>Look me up on</h6>
        <ul>
          
          <li><a href="https://twitter.com/sd_nicholas">Twitter</a></li>
          
          
          <li><a href="https://github.com/stephendnicholas">Github</a></li>
          
          
          <li><a href="https://www.linkedin.com/in/stephendnicholas">LinkedIn</a></li>
          
        </ul>
      </nav>
    </div>


    <div class="site-wrapper">

      <header>
        <div class="h-wrap">
          <h1 class="title"><a href="/" title="Back to Homepage">stephendnicholas.com</a></h1>
          <a class="menu-icon" title="Open Bio"><span class="lines"></span></a>
        </div>
      </header>

      <main>
        <section class="single-wrap">
  <article class="single-content" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="feat">
      <h5 class="page-date">
        <time datetime="2012-04-30T00:00:00-06:00" itemprop="datePublished">
          30 April 2012
        </time>
      </h5>
    </div>
    <h1 class="page-title" itemprop="name headline">A simple SSL enabled Comet style Pub/Sub server with Node.js</h1>
    <div itemprop="articleBody">
      <p>I’ve been meaning to have a play with Node.js for a while, but up until now I haven’t had a good reason. Running through a ‘Hello World’ example is all well and good, but I’m the kind of person who actually needs to do something when learning a new technology; otherwise I’ll just pick it up for an afternoon and then put it down and forget about it. </p>

<p>So I decided to try writing a simple SSL enabled Comet style pub/sub server (for reasons that may become apparent in future posts) and it turned out to be really easy; taking just over 100 lines of code (including comments and liberal spacing).</p>

<p>The complete code’s at the bottom of this post, so if that’s what your after, feel free to skip ahead.</p>

<p>Otherwise, I’m just going to quickly run through some of the steps it took me to get there:</p>

<h3 id="learning-the-basics-of-nodejs">1. Learning the basics of Node.js</h3>

<p>For this I turned to the <a href="http://www.nodebeginner.org/" target="_blank">The Node Beginner Book</a>, which I’d really recommend. It’s a nice advanced introduction for developers familiar with at least one object-orientated programming language and completely new to Node.js. It skips over the simple stuff, like data types and basic programming flows, and takes you through developing ‘<em>a complete web application which allows the users of this application to view web pages and upload files</em>’; introducing a lot of the important Node.js concepts along the way.</p>

<h3 id="figuring-out-how-to-implement-ssl-with-nodejs">2. Figuring out how to implement SSL with Node.js</h3>

<p>With a basic understanding of Node.js under my belt, I then decided to approach what I thought would be the most tricky part: adding SSL to the server. I’ve had issues with this before in different languages and so was expecting some pain; however it was pretty simple.</p>

<p>Here’s an quick example of how to create a SSL enabled ‘hello world’ server, taken from the <a href="http://nodejs.org/docs/v0.3.7/api/https.html" target="_blank">Node.js documentation for https</a>:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">//Include the https &amp; file system modules  </span>
<span class="kd">var</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>  
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>

<span class="c1">//Create the server options object, specifying the SSL key &amp; cert  </span>
<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>  
  <span class="nx">key</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;privatekey.pem&#39;</span><span class="p">),</span>  
  <span class="nx">cert</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;certificate.pem&#39;</span><span class="p">)</span>  
<span class="p">};</span>

<span class="c1">//Create the HTTPS enabled server - listening on port 8000  </span>
<span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>  
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>  
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;hello world\n&quot;</span><span class="p">);</span>  
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8000</span><span class="p">);</span></code></pre></div>

<p>It turned out the most tricky part was generating the certificates and this was still pretty easy. All I needed to do was install <a href="http://www.openssl.org/" target="_blank">openssl</a> and then issue the following command line commands:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">openssl genrsa -out privatekey.pem 1024</span>
<span class="go">openssl req -new -key privatekey.pem -out certrequest.csr</span>
<span class="go">openssl x509 -req -in certrequest.csr -signkey privatekey.pem -out certificate.pem</span></code></pre></div>

<p>One slight gotcha was that, as a Windows user, the second command (openssl req…) kept failing for me with the error message: <b>“Unable to load config info from /usr/local/ssl/openssl.cnf”</b>. A <a href="http://irwinj.blogspot.com/2008/11/unable-to-load-config-info-from.html" target="_blank">quick tip</a> pointed out that all you need to do to solve this is specify the config path yourself, by using -config. E.g.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">openssl req -new -key privatekey.pem -out certrequest.csr -config C:\OpenSSL-Win64\bin\openssl.cfg</span></code></pre></div>

<h3 id="figuring-out-how-to-do-comet-with-nodejs">3. Figuring out how to do Comet with Node.js</h3>

<p>Again it turns out this is really simple. Simple (at least for the moment) seems to be a word I’m associating a lot with Node.js. To implement a long polling Comet approach, the two key elements appear to be:</p>

<ol>
  <li>Set it so that the incoming connection doesn’t expire - by calling <code>req.connection.setTimeout(0);</code></li>
  <li>Store the response objects for the incoming connections somewhere and then use them to send the data later on.</li>
</ol>

<p>Here’s a relatively simple example (based on one I found <a href="http://zenmachine.wordpress.com/2010/01/31/node-js-and-comet/" target="_blank">here</a>) that causes each request to ‘/comet’ to wait up to 5 seconds before it gets a reply:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;sys&quot;</span><span class="p">);</span>  
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">);</span>

<span class="c1">//Array of responses awaiting replies  </span>
<span class="kd">var</span> <span class="nx">waitingResponses</span><span class="o">=</span><span class="p">[];</span>

<span class="c1">//Function that will send a message to each waiting response  </span>
<span class="kd">function</span> <span class="nx">sendToWaitingResponses</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">//If there are some waiting responses  </span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">waitingResponses</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//For each one - respond with &#39;Hello World - &lt;current timestamp&gt;&#39;  </span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">waitingResponses</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">waitingResponses</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> 
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-type&#39;</span><span class="o">:</span><span class="s1">&#39;text/plain&#39;</span><span class="p">});</span> 
      <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;Hello World - &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()));</span> 
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> 
    
  <span class="c1">//Schedule this method to be called again in 5 seconds </span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">sendToWaitingResponses</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
<span class="p">}</span> 
    
<span class="c1">//Schedule the first call of sendToWatitingResponses() for 5 seconds from now </span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">sendToWaitingResponses</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span> 
    
<span class="c1">//Start the server - listening on port 8000 </span>
<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span> 
  
  <span class="c1">//Only handle requests to /comet </span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">==</span> <span class="s1">&#39;/comet&#39;</span><span class="p">)</span> <span class="p">{</span> 
    <span class="c1">//Set it so the connection doesn&#39;t time out </span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> 
    
    <span class="c1">//Add the response object to the array of waiting responses </span>
    <span class="c1">//To be replied to at some point by the sendToWaitingResponses() method </span>
    <span class="nx">waitingResponses</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-type&#39;</span><span class="o">:</span><span class="s1">&#39;text/plain&#39;</span><span class="p">});</span> 
    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;not found&#39;</span><span class="p">);</span> 
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8000</span><span class="p">);</span></code></pre></div>

<p>Here I’ve used a repeating method (called every 5 seconds using <code>setTimeout(...)</code>) to trigger sending the data; however in a real implementation this would be triggered by some kind of event (e.g. a publish being received).</p>

<h3 id="putting-it-all-together">4. Putting it all together</h3>

<p>The final step was pulling all this together to create my pub/sub server; allowing applications to:</p>

<ul>
  <li><strong>Subscribe</strong> - by sending a GET request to <code>'/s?t=&lt;topic&gt;'</code>. The connection will then remain open until a publish for that topic comes in, at which point the message is sent and the connection closed.</li>
  <li><strong>Publish</strong> - by sending a POST request to <code>'/p?t=&lt;topic&gt;'</code> with the content of the message as the body of the post, encoded in utf-8.</li>
</ul>

<p>Here’s the full code, including copious comments, so hopefully you can understand what I’ve done:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>  
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>  
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>

<span class="c1">//Really undefined  </span>
<span class="kd">var</span> <span class="kc">undefined</span><span class="p">;</span>

<span class="c1">//Setup server options with SSL key &amp; cert  </span>
<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>  
  <span class="nx">key</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;privatekey.pem&#39;</span><span class="p">),</span>  
  <span class="nx">cert</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;certificate.pem&#39;</span><span class="p">)</span>  
<span class="p">};</span>

<span class="c1">//Multidimensional array of  </span>
<span class="c1">//[topic][subscription response objects waiting for data]  </span>
<span class="c1">//I.e. each topic has an array of response objects waiting for the next publish  </span>
<span class="kd">var</span> <span class="nx">subscriptions</span><span class="o">=</span><span class="p">[];</span>

<span class="c1">//Create the server - listenting on port 8000  </span>
<span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Incoming request for:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

  <span class="c1">//Parse out the pathname  </span>
  <span class="kd">var</span> <span class="nx">pathname</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span><span class="p">;</span>

  <span class="c1">//Parse out the topic query parameter  </span>
  <span class="c1">//Note: true tells parse(...) to parse the query string for us too (neat)  </span>
  <span class="kd">var</span> <span class="nx">topic</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">query</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">];</span>

  <span class="c1">//If subscribe request  </span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">pathname</span> <span class="o">==</span> <span class="s1">&#39;/s&#39;</span><span class="p">)</span> <span class="p">{</span> 

    <span class="c1">//If topic not specified - then error  </span>
    <span class="k">if</span><span class="p">(</span><span class="nx">topic</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>  
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; Error: Topic (t=...) not specified.&#39;</span><span class="p">);</span>  
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-type&#39;</span><span class="o">:</span><span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>  
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>  
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; Topic:&#39;</span><span class="p">,</span> <span class="nx">topic</span><span class="p">);</span>

      <span class="c1">//Set timeout to 0 - so the request doesn&#39;t timeout - making it comet-y  </span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

      <span class="c1">//Initialise the topic specific subscription array if it doesn&#39;t already exist  </span>
      <span class="k">if</span><span class="p">(</span><span class="nx">subscriptions</span><span class="p">[</span><span class="nx">topic</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>  
        <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">topic</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>  
      <span class="p">}</span>

      <span class="c1">//Add the response object to array of &#39;subscriptions&#39; to be served for that topic  </span>
      <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">topic</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>  
    <span class="p">}</span>  
  <span class="p">}</span>  
  <span class="c1">//Else if publish request  </span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pathname</span> <span class="o">==</span> <span class="s1">&#39;/p&#39;</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//If topic not specified - then error  </span>
    <span class="k">if</span><span class="p">(</span><span class="nx">topic</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>  
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; Error: Topic (t=...) not specified.&#39;</span><span class="p">);</span>  
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-type&#39;</span><span class="o">:</span><span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>  
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>  
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; Topic:&#39;</span><span class="p">,</span> <span class="nx">topic</span><span class="p">);</span>

      <span class="c1">//Parse in all the post data - the published &#39;message&#39;  </span>
      <span class="c1">//Each chunk of post data is simply appended to the var postData  </span>
      <span class="kd">var</span> <span class="nx">postData</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>  
      <span class="nx">req</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">);</span>  
      <span class="nx">req</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postDataChunk</span><span class="p">)</span> <span class="p">{</span>  
        <span class="nx">postData</span> <span class="o">+=</span> <span class="nx">postDataChunk</span><span class="p">;</span>  
      <span class="p">});</span>

      <span class="c1">//Once we&#39;ve got all the post data  </span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; All post data received. Post data:&#39;</span><span class="p">,</span> <span class="nx">postData</span><span class="p">);</span>

        <span class="c1">//For each subscription FOR THIS TOPIC - send them the post data and close with 200 response  </span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">subscriptions</span><span class="p">[</span><span class="nx">topic</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">topic</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>  
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">topic</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">topic</span><span class="p">][</span><span class="nx">i</span><span class="p">];</span> 
            <span class="nx">s</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-type&#39;</span><span class="o">:</span><span class="s1">&#39;text/plain&#39;</span><span class="p">});</span> 
            <span class="nx">s</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">postData</span><span class="p">);</span> 
            <span class="nx">s</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span> 
          <span class="p">}</span> 
          
          <span class="c1">//Clear all &#39;subscriptions&#39; for the topic </span>
          <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">topic</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span> 
        <span class="p">}</span>
        
        <span class="c1">//Send response to the publish request </span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-type&#39;</span><span class="o">:</span><span class="s1">&#39;text/plain&#39;</span><span class="p">});</span> 
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span> 
      <span class="p">});</span> 
    <span class="p">}</span>
  <span class="p">}</span> 
  <span class="c1">//Else not supported path </span>
  <span class="k">else</span> <span class="p">{</span> 
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; Not Found&#39;</span><span class="p">);</span> 
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-type&#39;</span><span class="o">:</span><span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
    
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Finished request.&#39;</span><span class="p">);</span> 

<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8000</span><span class="p">);</span></code></pre></div>

<p>Now, this is my first piece of Node programming, so please be gentle; however I don’t think I’ve done anything too stupid. First of all, it works and does what I want. Secondly, I think it should be relatively scalable (though I’ve not tested this). And thirdly, due to the single threaded nature of Node.js (Yay!) there <i>shouldn’t</i> be any real concurrency issues.</p>

<p>The one thing I am missing, is some kind of logic to purge dead connections, but I guess you can’t have everything :)</p>

    </div>
    
    <div class="share-title">Share via</div>
    
    <div class="feat share">
      <a href="http://twitter.com/share?text=A simple SSL enabled Comet style Pub/Sub server with Node.js - " class="popup">
        <span class="icon-twitter"></span>
      </a>
    </div>
    
    <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//stephendnicholas.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    
  </article>
</section>

      </main>

      <footer>
        <small>&copy; Stephen Nicholas, 2011 &ndash; 2016 </small>
      </footer>

    </div>
    

    <script src="/js/main.js"></script>
    
    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-72835313-1', 'stephendnicholas.com');
        ga('send', 'pageview');
      </script>
    

  </body>
</html>
